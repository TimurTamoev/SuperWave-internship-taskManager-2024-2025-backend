# Backend - Менеджер задач СуперВейв

Backend API для сервиса по организации задач ООО СуперВейв групп.

## Описание

RESTful API на FastAPI для управления пользователями, работы с email, создания шаблонов ответов и автоматической отправки ответов.

## Требования

- Python 3.9 или выше
- Windows 10/11 или Windows Server
- Доступ в интернет (для установки пакетов)

## Установка с нуля на Windows

### Шаг 1: Установка Python

1. Скачайте Python с официального сайта: https://www.python.org/downloads/
2. Запустите установщик
3. **ВАЖНО:** Установите флажок "Add Python to PATH" при установке
4. Нажмите "Install Now" и дождитесь завершения установки

Проверьте установку:
```cmd
python --version
```

Должна отобразиться версия Python 3.9 или выше.

### Шаг 2: Открытие командной строки в папке проекта

1. Откройте проводник Windows
2. Перейдите в папку с проектом (где находится файл `main.py`)
3. В адресной строке проводника введите `cmd` и нажмите Enter
   - Или щелкните правой кнопкой мыши в папке и выберите "Открыть в терминале" / "Open in Terminal"

### Шаг 3: Создание виртуального окружения

В командной строке выполните:

```cmd
python -m venv venv
```

Это создаст папку `venv` с изолированным окружением Python.

### Шаг 4: Активация виртуального окружения

```cmd
venv\Scripts\activate
```

После активации в начале строки появится `(venv)`.

**Примечание:** При каждом новом открытии командной строки нужно активировать виртуальное окружение заново.

### Шаг 5: Установка зависимостей

Убедитесь, что виртуальное окружение активировано (видите `(venv)` в начале строки), затем выполните:

```cmd
pip install --upgrade pip
pip install -r requirements.txt
```

Это может занять несколько минут.

### Шаг 6: Настройка переменных окружения

1. Скопируйте файл `env.example` и переименуйте его в `.env`:
   ```cmd
   copy env.example .env
   ```

2. Откройте файл `.env` в текстовом редакторе (Блокнот, Notepad++ и т.д.)

3. Заполните следующие обязательные параметры:

   ```env
   # Измените эти значения для продакшена
   SECRET_KEY="ваш-секретный-ключ-минимум-32-символа-случайные-символы"
   ENCRYPTION_KEY="ваш-ключ-шифрования-должен-быть-32-байта-измените-это"
   
   # Для продакшена установите:
   DEBUG=False
   ENVIRONMENT="Продакшен"
   
   # Укажите ваш домен вместо localhost
   CORS_ORIGINS=["http://ваш-домен.com", "https://ваш-домен.com"]
   
   # Настройки SMTP для отправки email
   SMTP_USERNAME="ваш_email@mail.ru"
   SMTP_PASSWORD="ваш_пароль_от_почты"
   SMTP_FROM_EMAIL="ваш_email@mail.ru"
   ```

   **ВНИМАНИЕ:**
   - `SECRET_KEY` и `ENCRYPTION_KEY` должны быть уникальными случайными строками
   - Для генерации можно использовать онлайн-генераторы или команду Python:
     ```cmd
     python -c "import secrets; print(secrets.token_urlsafe(32))"
     ```

4. Сохраните файл `.env`

### Шаг 7: Инициализация базы данных

База данных создастся автоматически при первом запуске. Но если нужно создать суперпользователя, сначала запустите:

```cmd
python create_superuser.py
```

Следуйте инструкциям для создания первого администратора.

### Шаг 8: Запуск приложения

Для разработки:
```cmd
python main.py
```

Приложение будет доступно по адресу: http://localhost:8000

API документация: http://localhost:8000/api/docs

## Запуск в продакшене

### Вариант 1: Использование uvicorn напрямую

```cmd
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

Где `--workers 4` означает количество рабочих процессов (настройте под ваш сервер).

### Вариант 2: Использование Windows Service (рекомендуется)

Для запуска как службы Windows используйте NSSM (Non-Sucking Service Manager):

1. Скачайте NSSM: https://nssm.cc/download
2. Распакуйте и перейдите в папку с вашей архитектурой (win64 или win32)
3. Откройте командную строку от имени администратора
4. Выполните:

```cmd
nssm install SWTaskManagerBackend "C:\путь\к\проекту\venv\Scripts\python.exe" "C:\путь\к\проекту\main.py"
```

5. В окне настроек службы укажите:
   - **Application:** путь к python.exe в venv
   - **Startup directory:** путь к папке проекта
   - **Arguments:** `main.py` или `-m uvicorn main:app --host 0.0.0.0 --port 8000`

6. Запустите службу:
```cmd
nssm start SWTaskManagerBackend
```

### Вариант 3: Использование обратного прокси (nginx/IIS)

Настройте nginx или IIS как обратный прокси на порт 8000.

## Структура проекта

```
backend/
├── app/
│   ├── api/           # API endpoints
│   ├── core/          # Конфигурация, БД, безопасность
│   ├── models/        # Модели базы данных
│   ├── schemas/       # Pydantic схемы
│   └── services/      # Бизнес-логика
├── tests/             # Тесты
├── main.py            # Точка входа
├── create_superuser.py # Скрипт создания админа
├── requirements.txt    # Зависимости
├── env.example        # Пример файла переменных окружения
└── README.md          # Этот файл
```

## API Endpoints

### Основные:

- `GET /` - Начальная страница
- `GET /health` - Проверка состояния сервера
- `GET /api/docs` - Интерактивная документация (Swagger)
- `GET /api/redoc` - Альтернативная документация (ReDoc)

### Аутентификация:

- `POST /api/v1/auth/login` - Вход
- `POST /api/v1/auth/users/register` - Регистрация (только админ)

### Пользователи:

- `GET /api/v1/users/me` - Информация о текущем пользователе
- `GET /api/v1/users/user/get/all` - Список всех пользователей (админ)
- `GET /api/v1/users/user/get/{user_id}` - Информация о пользователе (админ)

### Email:

- `POST /api/v1/emails/email/test/connection` - Проверка подключения к почте
- `POST /api/v1/emails/fetch` - Получение писем
- `GET /api/v1/emails/email/folders` - Список папок
- `GET /api/v1/emails/email/me` - Информация о настроенной почте

### Шаблоны ответов:

- `POST /api/v1/responses/response/create` - Создать шаблон
- `GET /api/v1/responses/response/all` - Все шаблоны
- `PUT /api/v1/responses/response/{template_id}` - Обновить шаблон
- `DELETE /api/v1/responses/response/{template_id}` - Удалить шаблон
- `POST /api/v1/responses/response/attach` - Прикрепить шаблон к письму

### Отправленные email:

- `GET /api/v1/responses/sent-emails/all` - История отправленных
- `GET /api/v1/responses/sent-emails/stats` - Статистика

## Важные замечания для продакшена

1. **Безопасность:**
   - Обязательно измените `SECRET_KEY` и `ENCRYPTION_KEY` в `.env`
   - Установите `DEBUG=False` для продакшена
   - Настройте правильные `CORS_ORIGINS` с вашими доменами
   - Используйте HTTPS в продакшене

2. **База данных:**
   - В текущей версии используется SQLite (`swtaskmanager.db`)
   - Для продакшена рекомендуется PostgreSQL или MySQL
   - Для смены БД измените `DATABASE_URL` в `.env`

3. **SMTP:**
   - Настройте реальные учетные данные SMTP для отправки email
   - Убедитесь, что SMTP сервер позволяет подключение

4. **Мониторинг:**
   - Настройте логирование
   - Используйте мониторинг для отслеживания работоспособности
   - Регулярно делайте резервные копии базы данных

5. **Производительность:**
   - Используйте несколько воркеров uvicorn в продакшене
   - Рассмотрите использование обратного прокси (nginx)
   - Настройте кэширование если необходимо

## Устранение неполадок

### Проблема: "python не является внутренней или внешней командой"

**Решение:** Python не добавлен в PATH. Переустановите Python с галочкой "Add Python to PATH" или добавьте путь вручную в переменные окружения Windows.

### Проблема: "ModuleNotFoundError"

**Решение:** Убедитесь, что виртуальное окружение активировано и установлены все зависимости:
```cmd
venv\Scripts\activate
pip install -r requirements.txt
```

### Проблема: Порт 8000 уже занят

**Решение:** Измените порт в `.env` файле (параметр `PORT`) или остановите процесс, занимающий порт.

### Проблема: Ошибка подключения к базе данных

**Решение:** Убедитесь, что файл базы данных имеет права на запись. Проверьте путь `DATABASE_URL` в `.env`.

### Проблема: SMTP не работает

**Решение:** 
- Проверьте учетные данные SMTP в `.env`
- Убедитесь, что почтовый сервер позволяет подключение
- Проверьте настройки файрвола

## Контакты и поддержка

Для вопросов и проблем обращайтесь к разработчику.

## Лицензия

Собственность ООО СуперВейв групп.

